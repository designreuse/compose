version: '3.7'
services:

  wordpress:
    image: wordpress:4.8.1
    hostname: wordpress
#    ports:
#      - 8101:80
    depends_on:
    - db
    networks:
    - proxy
    - wordpress-db
    volumes:
    - wordpress-data:/var/www/html
    deploy:
      labels:
      - com.df.notify=true
      - com.df.distribute=true
      - com.df.port=80
      - com.df.xForwardedProto=true
      - com.df.httpsOnly=true
      - com.df.serviceDomain=wordpress.swarm.usc.edu
      replicas: 2
      update_config:
        parallelism: 1
        delay: 10s
      restart_policy:
        condition: on-failure
    environment:
    - WORDPRESS_DB_PASSWORD=passw0rd
    - WORDPRESS_DB_HOST=wordpress-db
    - ServerName=wordpress.docker.usc.edu

  wordpress-db:
    image: mysql:5.7
    hostname: wordpress-db
    environment:
      MYSQL_ROOT_PASSWORD: passw0rd
    networks:
    - wordpress-db
    volumes:
    - wordpress-db:/var/lib/mysql
    deploy:
      replicas: 1
      update_config:
        parallelism: 1
        delay: 10s
      restart_policy:
        condition: on-failure

networks:
  wordpress-db:
    driver: overlay
  proxy:
    external: true

volumes:
  wordpress-db:
    external: true
  wordpress-data:
    external: true
#    external:
#      name: db-data
#      source: {{.Service.Name}}-{{.Task.Slot}}-vol
#    target: /mydata
#    driver_opts:
#      size: 25
#      backing: relocatable
#      ebstype: gp2
# volume-opt=size=10
#
# --mount type=volume,volume-driver=cloudstor:aws,source=sharedvol1,destination=/shareddata
#
# docker service create \
#  --replicas 5 \
#  --name ping3 \
#  --mount type=volume,volume-driver=cloudstor:aws,source={{.Service.Name}}-{{.Task.Slot}}-vol,destination=/mydata,volume-opt=backing=relocatable,volume-opt=size=25,volume-opt=ebstype=gp2 \
#  alpine ping docker.com
#
# volumes:
#  - type: volume
#    source: source={{.Service.Name}}-{{.Task.Slot}}-vol
#    target: /var/lib/mysql
#    volume:
